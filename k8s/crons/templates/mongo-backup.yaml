apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
data:
  backup.sh: |
    #!/bin/bash

    # Backup script content here
    BACKUP_NAME=${BACKUP_VERSION}_$(TZ=${TIMEZONE} date +"%Y%m%d%H%M%S")
    BACKUP_FILE=${BACKUP_DIR}/${BACKUP_NAME}

    echo ${BACKUP_FILE}

---

apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.mongoBackup.name }}-cron
spec:
  schedule: {{ quote .Values.mongoBackup.schedule }}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: {{ .Values.mongoBackup.name }}
            image: {{ .Values.mongoBackup.image.repository }}:{{ .Values.mongoBackup.image.tag }}
            env:
            - name: TIMEZONE
              value: {{ .Values.mongoBackup.env.tz }}
            - name: BACKUP_VERSION
              value: {{ .Values.mongoBackup.env.backupVersion }}
            - name: BACKUP_DIR
              value: {{ .Values.mongoBackup.env.backupDir }}
            command: ["/scripts/backup.sh"]
            volumeMounts:
            - name: backup-script
              mountPath: "/scripts"
          restartPolicy: OnFailure
          volumes:
          - name: backup-script
            configMap:
              name: backup-script
              defaultMode: 0500